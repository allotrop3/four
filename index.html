<html lang="en">
   <head>
      <meta charset="utf-8">

      <link rel="icon" type="image/png" href="/favicon.png">

      <title>Four</title>

      <link rel="stylesheet" type="text/css" href="/styles/four.css">
   </head>

   <body>
      <canvas></canvas>

      <script class="four__shader--default" type="x-shader/x-vertex">
         #version 100

         precision lowp float;

         struct camera
         {
            mat4 projectionMatrix;
            mat4 modelViewMatrix;
            mat3 normalMatrix;
         };

         attribute vec3 a_position;
         attribute vec2 a_uv;
         attribute vec3 a_normal;

         uniform camera u_camera;

         varying vec3 v_position;
         varying vec2 v_uv;
         varying vec3 v_normal;

         void main(void)
         {
            vec4 position = vec4(a_position, 1.0);

            gl_Position = u_camera.projectionMatrix * u_camera.modelViewMatrix * position;

            v_position = vec3(u_camera.modelViewMatrix * position);
            v_uv = a_uv;
            v_normal = normalize(u_camera.normalMatrix * a_normal);
         }
      </script>

      <script class="four__shader--default" type="x-shader/x-fragment">
         #version 100

         precision lowp float;

         struct material
         {
            vec3 ambient;
            vec3 diffuse;
            vec3 specular;
            int shading;
            float shininess;
            int type;
         };

         struct light
         {
            vec3 ambient;
            vec3 diffuse;
            vec3 specular;
            vec3 attenuation;
            float exponent;
            float cutoff;
            float intensity;
            vec3 location;
            vec3 direction;
            int type;
         };

         uniform sampler2D u_image;
         uniform material u_material;
         uniform light u_light;

         varying vec3 v_position;
         varying vec2 v_uv;
         varying vec3 v_normal;

         vec3 pointLight(vec3 base)
         {
            vec3 normal = normalize(v_normal);
            vec3 direction = normalize(u_light.location - v_position);
            float weight = max(dot(direction, normal), 0.0);
            vec3 color = vec3(0.0);
            float range = length(direction);
            float attenuation = 1.0 / (u_light.attenuation.x + u_light.attenuation.y * range + u_light.attenuation.z * pow(range, 2.0));
            vec3 ambient = u_light.ambient * u_material.ambient;
            vec3 diffuse = u_light.intensity * u_light.diffuse * (u_material.diffuse + base) * weight;
            vec3 specular = vec3(0.0);

            if (u_material.type == 1)
            {
               if (weight > 0.0)
               {
                  specular = u_light.specular * u_material.specular * pow(max(dot(reflect(-direction, normal), normalize(-v_position)), 0.0), u_material.shininess);
               }
            }

            return (ambient + diffuse + specular) * attenuation;
         }

         vec3 spotLight(vec3 base)
         {
            vec3 normal = normalize(v_normal);
            vec3 direction = normalize(u_light.location - v_position);
            vec3 aim = normalize(u_light.direction);
            float angle = acos(dot(-direction, aim));
            float cutoff = radians(clamp(u_light.cutoff, 0.0, 90.0));

            if (angle < cutoff)
            {
               return pointLight(base) * pow(dot(-direction, aim), u_light.exponent) * u_light.intensity;
            }
            else
            {
               return vec3(0.0);
            }
         }

         void main(void)
         {
            vec3 base = texture2D(u_image, v_uv).xyz;
            vec3 color = vec3(0.0);

            /* directional light */
            if (u_light.type == 1)
            {
               // todo
            }

            /* point light */
            if (u_light.type == 2)
            {
               color = pointLight(base);
            }

            /* spot light */
            if (u_light.type == 3)
            {
               color = spotLight(base);
            }

            gl_FragColor = vec4(color, 1.0);
         }
      </script>

      <script src="/scripts/four.min.js"></script>
      <script src="/scripts/test.js"></script>
   </body>
</html>