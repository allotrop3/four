<html lang="en">
   <head>
      <meta charset="utf-8">

      <title>Shadow mapping</title>
      
      <link rel="stylesheet" href="http://benvanik.github.io/WebGL-Inspector/core/lib/gli.all.css">
      
      <!--
      <script src="http://benvanik.github.io/WebGL-Inspector/core/lib/gli.all.js"></script>
      <script src="http://benvanik.github.io/WebGL-Inspector/core/embed.js"></script>
      -->
   </head>

   <body style="margin:0;background:#222;position:relative;overflow:hidden">
      <canvas></canvas>
      
      <script class="renderer" type="x-shader/x-vertex">
         #version 100

         precision mediump float;
      
         @Camera;
         @ShadowMapper;
         
         attribute vec3 a_position;
         attribute vec2 a_uv;
         attribute vec3 a_normal;
         
         varying vec4 v_position;
         varying vec2 v_uv;
         varying vec3 v_normal;
         
         uniform Camera u_camera;
         uniform Camera u_lightCamera;
         
         void main()
         {
            vec4 position = vec4(a_position, 1.0);
            
            v_position = position;
            v_uv = normalize(a_uv);
            v_normal = u_camera.normalMatrix * a_normal;
         
            shadow(u_lightCamera, position);
            
            gl_Position = u_camera.projectionMatrix * u_camera.modelViewMatrix * position;
         }
      </script>
      
      <script class="renderer" type="x-shader/x-fragment">
         #version 100

         precision mediump float;
         
         @Material;
         @Light;
         @PointLight;
         @ShadowMapper;
         
         uniform Light u_light;
         uniform Material u_material;
         
         varying vec4 v_position;
         varying vec2 v_uv;
         varying vec3 v_normal;
         
         void main()
         {
            gl_FragColor = vec4(pointLight(u_light, u_material, v_position, v_normal, vec3(0.0)) * visibility(0.1), 1.0);
         }
      </script>

      <script class="shadow-mapper" type="x-shader/x-vertex">
         #version 100

         precision mediump float;

         attribute vec3 a_position;
         
         @Camera;

         uniform Camera u_lightCamera;
         
         void main()
         {
            gl_Position = u_lightCamera.projectionMatrix * u_lightCamera.modelViewMatrix * vec4(a_position, 1.0);
         }
      </script>

      <script class="shadow-mapper" type="x-shader/x-fragment">
         #version 100

         precision mediump float;
         
         void main(void)
         {
            gl_FragColor = vec4(0.0);
         }
      </script>

      <script src="../dist/four.js"></script>

      <script>
         var monkeyLoader = new Four.OBJMeshLoader({ path: 'meshes/monkey.obj' });
         var planeLoader = new Four.OBJMeshLoader({ path: 'meshes/plane.obj' });

         setTimeout(function()
         {
            var width = Four.gl.canvas.width;
            var height = Four.gl.canvas.height;
            var shadowMapperProgram = new Four.Program({ selector: '.shadow-mapper' });
            var rendererProgram = new Four.Program({ selector: '.renderer' });
            var view = new Four.Framebuffer();
            var camera = new Four.PerspectiveCamera({ direction: [0, 0, 0], location: [-15, 5, 15] });
            var lightCamera = new Four.PerspectiveCamera({
               path: 'lightCamera',
               width: width,
               height: height,
               direction: [-1, -1, -1],
               location: [5, 10, 5]
            });
            var light = new Four.PointLight({ attenuation: [0.5, 0.5, 1], location: lightCamera.location });
            var monkey = new Four.Mesh({
               buffers: new Four.VertexArrayObject({ attributes: ['vec3 position', 'vec3 normal'] }),
               vertices: monkeyLoader.vertices,
               normals: monkeyLoader.normals,
               material: new Four.Material({ diffuse: 0xFFFFFF })
            });
            var plane = new Four.Mesh({
               buffers: new Four.VertexArrayObject({ attributes: ['vec3 position', 'vec3 normal'] }),
               vertices: planeLoader.vertices,
               normals: planeLoader.normals,
               material: new Four.Material({ diffuse: 0xFFFFFF })
            });
            var shadowMapper = new Four.ShadowMapper();
            var scene = new Four.Scene();
            
            scene.put(monkey);
            scene.put(plane);

            scene.use(shadowMapperProgram);
            light.bind(shadowMapperProgram);
            scene.render(shadowMapper.view, lightCamera);
            
            scene.use(rendererProgram);
            light.bind(rendererProgram);
            lightCamera.bind(rendererProgram);
            scene.animate(view, camera,
               function()
               {
                  shadowMapper.bind(rendererProgram);
               },
               function()
               {
                  shadowMapper.unbind();
               }
            );
         }, 2000);
      </script>
   </body>
</html>